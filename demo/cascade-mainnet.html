<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PAICE + NEAR Mainnet Cascade Demo</title>
  <style>
    :root {
      --bg: #0a0e1a;
      --surface: #121829;
      --surface2: #1a2236;
      --border: #2a3554;
      --text: #e4e8f1;
      --text-dim: #8892a8;
      --accent: #6c8cff;
      --accent2: #00d4aa;
      --green: #00d4aa;
      --orange: #ff9f43;
      --red: #ff6b6b;
      --near-green: #00ec97;
      --purple: #a78bfa;
      --pink: #f472b6;
      --radius: 12px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent), var(--near-green));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge-tee {
      background: rgba(0, 212, 170, 0.15);
      color: var(--green);
      border: 1px solid rgba(0, 212, 170, 0.3);
    }
    .badge-near {
      background: rgba(0, 236, 151, 0.15);
      color: var(--near-green);
      border: 1px solid rgba(0, 236, 151, 0.3);
    }
    .badge-mainnet {
      background: rgba(0, 236, 151, 0.15);
      color: var(--near-green);
      border: 1px solid rgba(0, 236, 151, 0.3);
    }
    .badge-testnet {
      background: rgba(255, 159, 67, 0.15);
      color: var(--orange);
      border: 1px solid rgba(255, 159, 67, 0.3);
    }
    .badge-cascade {
      background: rgba(167, 139, 250, 0.15);
      color: var(--purple);
      border: 1px solid rgba(167, 139, 250, 0.3);
    }
    .header-badges {
      display: flex;
      gap: 8px;
    }
    /* Layout */
    .main {
      display: grid;
      grid-template-columns: 1fr 420px;
      height: calc(100vh - 61px);
    }
    /* Chat Panel */
    .chat-panel {
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border);
    }
    .chat-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
    }
    .chat-header h2 { font-size: 16px; margin-bottom: 4px; }
    .chat-header p { font-size: 13px; color: var(--text-dim); }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .msg {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: var(--radius);
      font-size: 14px;
      line-height: 1.5;
    }
    .msg-user {
      align-self: flex-end;
      background: var(--accent);
      color: white;
    }
    .msg-ai {
      align-self: flex-start;
      background: var(--surface2);
      border: 1px solid var(--border);
    }
    .msg-system {
      align-self: center;
      background: rgba(0, 212, 170, 0.1);
      border: 1px solid rgba(0, 212, 170, 0.2);
      color: var(--green);
      font-size: 12px;
      padding: 8px 16px;
    }
    .msg-middleware {
      align-self: center;
      background: rgba(167, 139, 250, 0.1);
      border: 1px solid rgba(167, 139, 250, 0.2);
      color: var(--purple);
      font-size: 11px;
      padding: 6px 12px;
      max-width: 90%;
    }
    .msg-ai .model-tag {
      font-size: 11px;
      color: var(--text-dim);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .model-tag .dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--green);
      display: inline-block;
    }
    .model-tag .dot-middleware {
      background: var(--purple);
    }
    .model-tag .dot-eval {
      background: var(--orange);
    }
    .typing-indicator {
      display: none;
      align-self: flex-start;
      padding: 12px 16px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }
    .typing-indicator.active { display: flex; gap: 4px; align-items: center; }
    .typing-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--text-dim);
      animation: typing 1.4s infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing {
      0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
      30% { opacity: 1; transform: translateY(-4px); }
    }
    .chat-input-area {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      background: var(--surface);
      display: flex;
      gap: 10px;
    }
    .chat-input-area input {
      flex: 1;
      padding: 10px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--surface2);
      color: var(--text);
      font-size: 14px;
      outline: none;
    }
    .chat-input-area input:focus { border-color: var(--accent); }
    .chat-input-area input::placeholder { color: var(--text-dim); }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: var(--accent);
      color: white;
    }
    .btn-primary:hover { background: #5a7aee; }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-green {
      background: var(--green);
      color: #0a0e1a;
    }
    .btn-green:hover { background: #00b890; }
    .btn-green:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-outline {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn-outline:hover { border-color: var(--accent); color: var(--accent); }
    /* Right Panel */
    .right-panel {
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      background: var(--surface);
    }
    .panel-section {
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }
    .panel-section h3 {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-dim);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    /* Cascade Display */
    .cascade-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .cascade-layer {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .cascade-layer .layer-icon {
      width: 32px; height: 32px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }
    .cascade-layer.layer-chat .layer-icon {
      background: rgba(108, 140, 255, 0.2);
      color: var(--accent);
    }
    .cascade-layer.layer-middleware .layer-icon {
      background: rgba(167, 139, 250, 0.2);
      color: var(--purple);
    }
    .cascade-layer.layer-eval .layer-icon {
      background: rgba(255, 159, 67, 0.2);
      color: var(--orange);
    }
    .cascade-layer .layer-info {
      flex: 1;
      min-width: 0;
    }
    .cascade-layer .layer-role {
      font-size: 11px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .cascade-layer .layer-model {
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .cascade-layer .layer-fallback {
      font-size: 10px;
      color: var(--text-dim);
    }
    .cascade-layer .layer-status {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--text-dim);
      flex-shrink: 0;
    }
    .cascade-layer .layer-status.active {
      background: var(--green);
      box-shadow: 0 0 6px rgba(0, 212, 170, 0.5);
    }
    .cascade-layer .layer-status.using-fallback {
      background: var(--orange);
      box-shadow: 0 0 6px rgba(255, 159, 67, 0.5);
    }
    /* Score Display */
    .score-card {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
    }
    .score-overall {
      text-align: center;
      margin-bottom: 16px;
    }
    .score-number {
      font-size: 48px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent), var(--green));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .score-tier {
      font-size: 18px;
      font-weight: 600;
      color: var(--green);
    }
    .score-dimensions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .dim-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
    }
    .dim-bar-container {
      flex: 1;
      height: 6px;
      background: var(--bg);
      border-radius: 3px;
      margin: 0 10px;
      overflow: hidden;
    }
    .dim-bar {
      height: 100%;
      border-radius: 3px;
      background: var(--accent);
      transition: width 0.5s ease;
    }
    /* Attestation */
    .attestation-card {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
    }
    .attestation-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      padding: 6px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .attestation-row:last-child { border-bottom: none; }
    .attestation-label { color: var(--text-dim); }
    .attestation-value {
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 12px;
      color: var(--text);
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .attestation-value a {
      color: var(--near-green);
      text-decoration: none;
    }
    .attestation-value a:hover { text-decoration: underline; }
    .verified-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: rgba(0, 236, 151, 0.1);
      border: 1px solid rgba(0, 236, 151, 0.3);
      border-radius: 8px;
      color: var(--near-green);
      font-size: 14px;
      font-weight: 600;
      margin-top: 12px;
    }
    /* Steps */
    .step-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .step-item {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      padding: 8px 12px;
      border-radius: 8px;
      background: var(--surface2);
      border: 1px solid var(--border);
    }
    .step-icon {
      width: 24px; height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      flex-shrink: 0;
    }
    .step-pending .step-icon {
      background: var(--bg);
      border: 2px solid var(--text-dim);
      color: var(--text-dim);
    }
    .step-active .step-icon {
      background: var(--accent);
      color: white;
      animation: pulse 1.5s infinite;
    }
    .step-done .step-icon {
      background: var(--green);
      color: var(--bg);
    }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(108, 140, 255, 0.4); }
      50% { box-shadow: 0 0 0 6px rgba(108, 140, 255, 0); }
    }
    /* Config Panel */
    .config-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 12px;
    }
    .config-row label {
      font-size: 12px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .config-row select, .config-row input[type="text"] {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--surface2);
      color: var(--text);
      font-size: 13px;
      outline: none;
    }
    .config-row select:focus, .config-row input[type="text"]:focus {
      border-color: var(--accent);
    }
    /* Hidden state */
    .hidden { display: none !important; }
    /* Status bar */
    .status-bar {
      padding: 8px 20px;
      font-size: 12px;
      color: var(--text-dim);
      border-top: 1px solid var(--border);
      background: var(--surface);
      display: flex;
      justify-content: space-between;
    }
    .status-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
    }
    .status-dot.connected { background: var(--green); }
    .status-dot.disconnected { background: var(--red); }
    /* Actions bar */
    .actions-bar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .actions-bar .btn { font-size: 12px; padding: 8px 14px; }
    /* Log area */
    .log-area {
      background: #0d1117;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      max-height: 200px;
      overflow-y: auto;
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 11px;
      line-height: 1.6;
      color: var(--text-dim);
    }
    .log-area .log-info { color: var(--accent); }
    .log-area .log-success { color: var(--green); }
    .log-area .log-error { color: var(--red); }
    .log-area .log-warn { color: var(--orange); }
    .log-area .log-middleware { color: var(--purple); }
    /* Eval model indicator */
    .eval-indicator {
      background: rgba(255, 159, 67, 0.1);
      border: 1px solid rgba(255, 159, 67, 0.2);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 12px;
      color: var(--orange);
      margin-top: 8px;
      text-align: center;
    }
    .middleware-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-dim);
    }
    .middleware-toggle input[type="checkbox"] {
      accent-color: var(--purple);
    }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <span class="logo">PAICE + NEAR</span>
      <span class="badge badge-cascade">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v6m0 4v6m-6-8h12"/><circle cx="12" cy="12" r="2"/></svg>
        Cascade
      </span>
      <span class="badge badge-tee">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        TEE Protected
      </span>
      <span class="badge badge-near">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        NEAR Verified
      </span>
      <span class="badge badge-testnet">testnet</span>
    </div>
    <div class="header-badges">
      <span style="font-size:12px;color:var(--text-dim);">NEARCON Innovation Sandbox 2026</span>
    </div>
  </div>

  <!-- Main Layout -->
  <div class="main">
    <!-- Chat Panel -->
    <div class="chat-panel">
      <div class="chat-header">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <h2>AI Collaboration Assessment</h2>
            <p>Three-layer cascade &mdash; Chat, Middleware, Evaluation</p>
          </div>
          <div style="display:flex;flex-direction:column;gap:4px;align-items:flex-end;">
            <div class="middleware-toggle">
              <input type="checkbox" id="middlewareToggle" checked />
              <label for="middlewareToggle">Middleware layer</label>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="msg msg-system">
          Cascade active: GPT OSS 120B (Chat) &rarr; Qwen3 30B (Middleware) &rarr; GLM 4.7 (Evaluation). All models run inside TEE enclaves via NEAR AI Cloud.
        </div>
        <div class="msg msg-ai">
          <div class="model-tag"><span class="dot"></span> GPT OSS 120B &middot; Chat Layer &middot; Private</div>
          Welcome to PAICE! I'm here to assess how effectively you collaborate with AI. Let's explore how you approach problem-solving with AI tools. Could you tell me about a recent situation where you used AI to help with a work task?
        </div>
      </div>
      <div class="typing-indicator" id="typingIndicator">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
      <div class="chat-input-area">
        <input type="text" id="chatInput" placeholder="Type your response..." autocomplete="off" />
        <button class="btn btn-primary" id="sendBtn" onclick="sendMessage()">Send</button>
      </div>
    </div>

    <!-- Right Panel -->
    <div class="right-panel">
      <!-- Cascade Architecture -->
      <div class="panel-section">
        <h3>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v6m0 4v6m-6-8h12"/><circle cx="12" cy="12" r="2"/></svg>
          Model Cascade
        </h3>
        <div class="cascade-grid">
          <div class="cascade-layer layer-chat" id="cascadeChat">
            <div class="layer-icon">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            </div>
            <div class="layer-info">
              <div class="layer-role">Chat Partner</div>
              <div class="layer-model" id="chatModelLabel">GPT OSS 120B</div>
              <div class="layer-fallback">Fallback: DeepSeek V3.1</div>
            </div>
            <div class="layer-status active" id="chatStatus"></div>
          </div>
          <div class="cascade-layer layer-middleware" id="cascadeMiddleware">
            <div class="layer-icon">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
            </div>
            <div class="layer-info">
              <div class="layer-role">Middleware (QA)</div>
              <div class="layer-model" id="mwModelLabel">Qwen3 30B</div>
              <div class="layer-fallback">Fallback: DeepSeek V3.1</div>
            </div>
            <div class="layer-status" id="mwStatus"></div>
          </div>
          <div class="cascade-layer layer-eval" id="cascadeEval">
            <div class="layer-icon">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>
            </div>
            <div class="layer-info">
              <div class="layer-role">Evaluation</div>
              <div class="layer-model" id="evalModelLabel">GLM 4.7</div>
              <div class="layer-fallback">Fallback: GPT OSS 120B</div>
            </div>
            <div class="layer-status" id="evalStatus"></div>
          </div>
        </div>
      </div>

      <!-- Pipeline Steps -->
      <div class="panel-section">
        <h3>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
          Integration Pipeline
        </h3>
        <ul class="step-list" id="stepList">
          <li class="step-item step-done" id="step-1"><span class="step-icon">&#10003;</span> Connect to NEAR AI Cloud</li>
          <li class="step-item step-active" id="step-2"><span class="step-icon">2</span> Chat via TEE-protected cascade</li>
          <li class="step-item step-pending" id="step-3"><span class="step-icon">3</span> Middleware QA check</li>
          <li class="step-item step-pending" id="step-4"><span class="step-icon">4</span> Generate assessment scores (GLM 4.7)</li>
          <li class="step-item step-pending" id="step-5"><span class="step-icon">5</span> Hash score payload (SHA-256)</li>
          <li class="step-item step-pending" id="step-6"><span class="step-icon">6</span> Write attestation to NEAR mainnet</li>
          <li class="step-item step-pending" id="step-7"><span class="step-icon">7</span> Verify on-chain</li>
        </ul>
      </div>

      <!-- Assessment Scores (hidden until generated) -->
      <div class="panel-section hidden" id="scoreSection">
        <h3>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>
          Assessment Results
        </h3>
        <div class="score-card">
          <div class="score-overall">
            <div class="score-number" id="overallScore">--</div>
            <div style="font-size:11px;color:var(--text-dim);margin-top:-2px">/1000</div>
            <div class="score-tier" id="scoreTier">--</div>
          </div>
          <div class="score-dimensions" id="scoreDimensions"></div>
          <div class="eval-indicator" id="evalIndicator"></div>
        </div>
      </div>

      <!-- Attestation (hidden until written) -->
      <div class="panel-section hidden" id="attestationSection">
        <h3>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          On-Chain Attestation
        </h3>
        <div class="attestation-card" id="attestationCard"></div>
      </div>

      <!-- Actions -->
      <div class="panel-section">
        <h3>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
          Actions
        </h3>
        <div class="actions-bar">
          <button class="btn btn-green" id="assessBtn" onclick="runAssessment()">Generate Assessment</button>
          <button class="btn btn-primary" id="attestBtn" onclick="runAttestation()" disabled>Attest on NEAR</button>
          <button class="btn btn-outline" id="verifyBtn" onclick="runVerification()" disabled>Verify</button>
          <button class="btn btn-outline" onclick="resetDemo()">Reset</button>
        </div>
      </div>

      <!-- Config -->
      <div class="panel-section">
        <h3>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
          Configuration
        </h3>
        <div class="config-row">
          <label>NEAR AI API Key</label>
          <input type="text" id="apiKeyInput" placeholder="sk-..." value="" />
        </div>
        <div class="config-row">
          <label>Contract Address</label>
          <input type="text" id="contractInput" value="e756da-67e557-1771270439.nearplay.testnet" />
        </div>
        <div class="config-row">
          <label>Network</label>
          <select id="networkSelect">
            <option value="testnet" selected>Testnet</option>
            <option value="mainnet">Mainnet</option>
          </select>
        </div>
      </div>

      <!-- Activity Log -->
      <div class="panel-section">
        <h3>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
          Activity Log
        </h3>
        <div class="log-area" id="logArea">
          <div class="log-info">[init] PAICE + NEAR Mainnet Cascade Demo loaded</div>
          <div class="log-success">[cascade] Chat: GPT OSS 120B (Private)</div>
          <div class="log-middleware">[cascade] Middleware: Qwen3 30B (Private)</div>
          <div class="log-warn">[cascade] Evaluation: GLM 4.7 (Private)</div>
          <div class="log-info">[config] Contract: e756da-67e557-1771270439.nearplay.testnet (testnet)</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="status-bar">
    <span><span class="status-dot connected" id="statusDot"></span> <span id="statusText">NEAR AI Cloud connected &mdash; 3-layer cascade active</span></span>
    <span id="tokenCount">Tokens: 0 in / 0 out | Cost: $0.0000</span>
  </div>

  <script>
    // =========================================================
    // CASCADE CONFIGURATION
    // =========================================================
    const CASCADE = {
      chat: {
        primary: { model: 'openai/gpt-oss-120b', label: 'GPT OSS 120B', pricing: { in: 0.15, out: 0.55 } },
        fallback: { model: 'deepseek-ai/DeepSeek-V3.1', label: 'DeepSeek V3.1', pricing: { in: 1.05, out: 3.10 } }
      },
      middleware: {
        primary: { model: 'Qwen/Qwen3-30B-A3B-Instruct-2507', label: 'Qwen3 30B', pricing: { in: 0.15, out: 0.55 } },
        fallback: { model: 'deepseek-ai/DeepSeek-V3.1', label: 'DeepSeek V3.1', pricing: { in: 1.05, out: 3.10 } }
      },
      eval: {
        primary: { model: 'zai-org/GLM-4.7', label: 'GLM 4.7', pricing: { in: 0.85, out: 3.30 } },
        fallback: { model: 'openai/gpt-oss-120b', label: 'GPT OSS 120B', pricing: { in: 0.15, out: 0.55 } }
      }
    };

    // Use NEAR AI Cloud directly on localhost; proxy via PAICE backend on GitHub Pages
    // (NEAR AI Cloud doesn't set CORS headers for non-localhost origins)
    const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    const API_BASE = isLocalhost
      ? 'https://cloud-api.near.ai/v1'
      : 'https://paice-development-backend.onrender.com/api/v1/near/ai';

    // =========================================================
    // STATE
    // =========================================================
    const state = {
      messages: [
        { role: 'system', content: `You are a PAICE AI collaboration assessor. You are evaluating how effectively the user collaborates with AI. Ask probing questions about their AI usage, observe their communication patterns, and assess across 5 dimensions: Performance, Accountability, Integrity, Collaboration, and Evolution. Keep responses concise (2-3 sentences). After 3-5 exchanges, you can provide a summary assessment.` },
        { role: 'assistant', content: `Welcome to PAICE! I'm here to assess how effectively you collaborate with AI. Let's explore how you approach problem-solving with AI tools. Could you tell me about a recent situation where you used AI to help with a work task?` }
      ],
      sessionId: 'paice-' + Date.now() + '-' + Math.random().toString(36).substr(2, 8),
      totalInputTokens: 0,
      totalOutputTokens: 0,
      totalCost: 0,
      scores: null,
      attestation: null,
      messageCount: 0,
      cascadeStats: {
        chat: { calls: 0, fallbacks: 0, lastModel: null },
        middleware: { calls: 0, fallbacks: 0, flagged: 0, lastModel: null },
        eval: { calls: 0, fallbacks: 0, lastModel: null }
      }
    };

    // =========================================================
    // LOGGING
    // =========================================================
    function log(msg, level = 'info') {
      const logArea = document.getElementById('logArea');
      const ts = new Date().toLocaleTimeString();
      logArea.innerHTML += `<div class="log-${level}">[${ts}] ${msg}</div>`;
      logArea.scrollTop = logArea.scrollHeight;
    }

    // =========================================================
    // CASCADE API CALL WITH FALLBACK
    // =========================================================
    async function cascadeCall(layer, messages, options = {}) {
      const apiKey = document.getElementById('apiKeyInput').value.trim();
      if (!apiKey) throw new Error('API key required');

      const config = CASCADE[layer];
      const maxTokens = options.maxTokens || 500;
      const temperature = options.temperature || 0.7;

      // Try primary model
      const startPrimary = performance.now();
      try {
        log(`[${layer}] Calling ${config.primary.label}...`, 'info');
        setCascadeStatus(layer, 'active');

        const resp = await fetch(`${API_BASE}/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: config.primary.model,
            messages: messages,
            temperature: temperature,
            max_tokens: maxTokens
          })
        });

        const data = await resp.json();
        if (data.error) throw new Error(data.error.message || JSON.stringify(data.error));

        const content = data.choices[0].message.content;
        if (!content) throw new Error('Model returned empty content (reasoning tokens exhausted)');

        const usage = data.usage || {};
        const elapsed = ((performance.now() - startPrimary) / 1000).toFixed(1);
        const cost = (usage.prompt_tokens || 0) * config.primary.pricing.in / 1e6 +
                     (usage.completion_tokens || 0) * config.primary.pricing.out / 1e6;

        state.totalInputTokens += usage.prompt_tokens || 0;
        state.totalOutputTokens += usage.completion_tokens || 0;
        state.totalCost += cost;
        state.cascadeStats[layer].calls++;
        state.cascadeStats[layer].lastModel = config.primary.label;

        log(`[${layer}] ${config.primary.label} responded (${elapsed}s, ${usage.completion_tokens || '?'} tokens)`, 'success');

        return {
          content: content,
          model: config.primary.label,
          modelId: config.primary.model,
          usedFallback: false,
          usage: usage,
          latency: elapsed,
          cost: cost
        };

      } catch (primaryErr) {
        log(`[${layer}] Primary (${config.primary.label}) failed: ${primaryErr.message}`, 'warn');

        // Try fallback
        const startFallback = performance.now();
        try {
          log(`[${layer}] Falling back to ${config.fallback.label}...`, 'warn');
          setCascadeStatus(layer, 'using-fallback');

          const resp = await fetch(`${API_BASE}/chat/completions`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: config.fallback.model,
              messages: messages,
              temperature: temperature,
              max_tokens: maxTokens
            })
          });

          const data = await resp.json();
          if (data.error) throw new Error(data.error.message || JSON.stringify(data.error));

          const content = data.choices[0].message.content;
          if (!content) throw new Error('Fallback also returned empty content');

          const usage = data.usage || {};
          const elapsed = ((performance.now() - startFallback) / 1000).toFixed(1);
          const cost = (usage.prompt_tokens || 0) * config.fallback.pricing.in / 1e6 +
                       (usage.completion_tokens || 0) * config.fallback.pricing.out / 1e6;

          state.totalInputTokens += usage.prompt_tokens || 0;
          state.totalOutputTokens += usage.completion_tokens || 0;
          state.totalCost += cost;
          state.cascadeStats[layer].calls++;
          state.cascadeStats[layer].fallbacks++;
          state.cascadeStats[layer].lastModel = config.fallback.label;

          log(`[${layer}] ${config.fallback.label} responded (${elapsed}s)`, 'success');

          return {
            content: content,
            model: config.fallback.label,
            modelId: config.fallback.model,
            usedFallback: true,
            usage: usage,
            latency: elapsed,
            cost: cost
          };

        } catch (fallbackErr) {
          setCascadeStatus(layer, '');
          throw new Error(`Both models failed. Primary: ${primaryErr.message}. Fallback: ${fallbackErr.message}`);
        }
      }
    }

    function setCascadeStatus(layer, status) {
      const statusIds = { chat: 'chatStatus', middleware: 'mwStatus', eval: 'evalStatus' };
      const el = document.getElementById(statusIds[layer]);
      if (!el) return;
      el.className = 'layer-status';
      if (status) el.classList.add(status);
    }

    // =========================================================
    // CHAT
    // =========================================================
    function addMessage(role, content, modelInfo = null) {
      const container = document.getElementById('chatMessages');
      const div = document.createElement('div');

      if (role === 'ai') {
        div.className = 'msg msg-ai';
        const tag = modelInfo || 'NEAR AI Cloud';
        div.innerHTML = `<div class="model-tag"><span class="dot"></span> ${escapeHtml(tag)}</div>${escapeHtml(content)}`;
      } else if (role === 'middleware') {
        div.className = 'msg msg-middleware';
        div.innerHTML = `<span style="font-weight:600;">Middleware:</span> ${escapeHtml(content)}`;
      } else if (role === 'system') {
        div.className = 'msg msg-system';
        div.textContent = content;
      } else {
        div.className = 'msg msg-user';
        div.textContent = content;
      }

      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (!text) return;

      const apiKey = document.getElementById('apiKeyInput').value.trim();
      if (!apiKey) {
        log('API key required. Enter your NEAR AI Cloud API key in Configuration.', 'error');
        return;
      }

      input.value = '';
      addMessage('user', text);
      state.messages.push({ role: 'user', content: text });
      state.messageCount++;

      const typingEl = document.getElementById('typingIndicator');
      typingEl.classList.add('active');
      document.getElementById('sendBtn').disabled = true;

      try {
        // ---- CHAT LAYER ----
        const chatResult = await cascadeCall('chat', state.messages, {
          maxTokens: 500,
          temperature: 0.7
        });

        const reply = chatResult.content;
        state.messages.push({ role: 'assistant', content: reply });
        typingEl.classList.remove('active');

        const modelTag = `${chatResult.model} \u00b7 Chat Layer \u00b7 Private${chatResult.usedFallback ? ' (fallback)' : ''}`;
        addMessage('ai', reply, modelTag);

        // ---- MIDDLEWARE LAYER (optional) ----
        const mwEnabled = document.getElementById('middlewareToggle').checked;
        if (mwEnabled && state.messageCount >= 1) {
          await runMiddleware(reply);
        }

        updateTokenDisplay();

        // Enable assessment after 1+ exchanges
        if (state.messageCount >= 1) {
          document.getElementById('assessBtn').disabled = false;
        }

      } catch (err) {
        typingEl.classList.remove('active');
        log(`[chat] Error: ${err.message}`, 'error');
        addMessage('system', `Error: ${err.message}`);
      }

      document.getElementById('sendBtn').disabled = false;
      document.getElementById('chatInput').focus();
    }

    // =========================================================
    // MIDDLEWARE LAYER
    // =========================================================
    async function runMiddleware(aiResponse) {
      updateStep(3, 'active');

      const mwPrompt = [
        { role: 'system', content: `You are a PAICE quality assurance middleware. Your job is to analyze the AI assessor's latest response and check for:
1. Did the assessor ask a relevant probing question?
2. Is the response staying on-topic for AI collaboration assessment?
3. Did the assessor avoid giving away scoring criteria?
4. Is the response appropriately concise (not too long/short)?

Respond with a brief JSON: {"pass": true/false, "note": "brief reason"}. Be strict but fair.` },
        { role: 'user', content: `AI assessor's latest response: "${aiResponse}"

Context: This is exchange #${state.messageCount} of a PAICE AI collaboration assessment. Evaluate quality.` }
      ];

      try {
        const mwResult = await cascadeCall('middleware', mwPrompt, {
          maxTokens: 200,
          temperature: 0.2
        });

        // Parse middleware result
        const jsonMatch = mwResult.content.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          const mwData = JSON.parse(jsonMatch[0]);
          const passed = mwData.pass !== false;
          const note = mwData.note || (passed ? 'Quality check passed' : 'Issue detected');

          if (passed) {
            log(`[middleware] QA passed: ${note}`, 'middleware');
          } else {
            log(`[middleware] QA flagged: ${note}`, 'warn');
            state.cascadeStats.middleware.flagged++;
            addMessage('middleware', `QA check: ${note}`);
          }
        } else {
          log(`[middleware] Could not parse QA response`, 'warn');
        }

        updateStep(3, 'done');

      } catch (err) {
        log(`[middleware] Skipped: ${err.message}`, 'warn');
        updateStep(3, 'done');
      }
    }

    // =========================================================
    // ASSESSMENT (GLM 4.7 primary, GPT OSS fallback)
    // =========================================================
    async function runAssessment() {
      const apiKey = document.getElementById('apiKeyInput').value.trim();
      if (!apiKey) {
        log('API key required.', 'error');
        return;
      }

      log('[eval] Generating assessment via cascade evaluation layer...', 'info');
      updateStep(4, 'active');
      document.getElementById('assessBtn').disabled = true;

      const evalPrompt = {
        role: 'user',
        content: `You are the PAICE Evaluator. Analyze the conversation and score 5 collaboration dimensions on a 0-100 scale.

SCORING CALIBRATION (critical \u2014 do not inflate):
- 0-29: Constrained \u2014 minimal engagement, no iteration, surface-level interaction
- 30-49: Informed \u2014 some task clarity, occasional verification, inconsistent follow-through
- 50-69: Proficient \u2014 regular iteration, consistent verification, adapts to feedback
- 70-89: Advanced \u2014 systematic verification, proactive refinement, demonstrates learning
- 90-100: Exceptional \u2014 catches subtle issues, innovative approaches, meta-aware

IMPORTANT: Most typical conversations score 20-40. Productive conversations score 40-55. Score only demonstrated behaviors. Absence of evidence = default to 30. Short conversations with only 1-3 exchanges should rarely exceed 40 overall. Do NOT artificially inflate.

DIMENSIONS:
- Performance: How they frame tasks and evaluate results
- Accountability: How they verify outputs and handle errors
- Integrity: How they maintain accuracy and context
- Collaboration: How they iterate and refine with AI
- Evolution: How they learn and adapt their approach

Return ONLY valid JSON in this exact format:
{
  "overall_score": 35,
  "dimensions": {
    "Performance": 38,
    "Accountability": 30,
    "Integrity": 35,
    "Collaboration": 32,
    "Evolution": 30
  },
  "summary": "Brief 1-sentence assessment summary"
}`
      };

      try {
        // GLM 4.7 needs more tokens for its reasoning process
        const evalResult = await cascadeCall('eval', [...state.messages, evalPrompt], {
          maxTokens: 2000,
          temperature: 0.3
        });

        // Extract JSON from response
        const jsonMatch = evalResult.content.match(/\{[\s\S]*\}/);
        if (!jsonMatch) throw new Error('No JSON found in evaluation response');

        const scores = JSON.parse(jsonMatch[0]);
        state.scores = scores;

        // Display scores
        displayScores(scores, evalResult);
        updateStep(4, 'done');

        log(`[eval] Assessment complete via ${evalResult.model}${evalResult.usedFallback ? ' (fallback)' : ''}: ${scores.tier} \u2014 ${scores.display_score}/1000 (${evalResult.latency}s)`, 'success');
        document.getElementById('attestBtn').disabled = false;

        updateTokenDisplay();

      } catch (err) {
        log(`[eval] Error: ${err.message}`, 'error');
        document.getElementById('assessBtn').disabled = false;
        setCascadeStatus('eval', '');
      }
    }

    // PAICE tier system: stored 0-100, display 0-1000
    function getTier(storedScore) {
      const display = Math.round(storedScore * 10);
      if (display >= 900) return { code: 'E', label: 'Exceptional', display };
      if (display >= 700) return { code: 'A', label: 'Advanced', display };
      if (display >= 500) return { code: 'P', label: 'Proficient', display };
      if (display >= 300) return { code: 'I', label: 'Informed', display };
      return { code: 'C', label: 'Constrained', display };
    }

    function displayScores(scores, evalResult) {
      document.getElementById('scoreSection').classList.remove('hidden');

      const tier = getTier(scores.overall_score);
      document.getElementById('overallScore').textContent = tier.display;
      document.getElementById('scoreTier').textContent = tier.label;
      scores.tier = tier.label;
      scores.display_score = tier.display;

      const dimContainer = document.getElementById('scoreDimensions');
      dimContainer.innerHTML = '';
      const colors = {
        'Performance': '#6c8cff',
        'Accountability': '#ff9f43',
        'Integrity': '#00d4aa',
        'Collaboration': '#a78bfa',
        'Evolution': '#f472b6'
      };

      for (const [dim, val] of Object.entries(scores.dimensions)) {
        const dimTier = getTier(val);
        const barPct = val;
        dimContainer.innerHTML += `
          <div class="dim-row">
            <span style="min-width:100px">${dim}</span>
            <div class="dim-bar-container">
              <div class="dim-bar" style="width:${barPct}%;background:${colors[dim] || 'var(--accent)'}"></div>
            </div>
            <span style="min-width:36px;text-align:right;font-weight:600">${dimTier.display}</span>
          </div>`;
      }

      // Show which model evaluated
      const indicator = document.getElementById('evalIndicator');
      indicator.innerHTML = `Evaluated by <strong>${evalResult.model}</strong>${evalResult.usedFallback ? ' (fallback)' : ''} in ${evalResult.latency}s`;
      if (scores.summary) {
        indicator.innerHTML += `<br><span style="color:var(--text-dim);font-size:11px">${escapeHtml(scores.summary)}</span>`;
      }
    }

    // =========================================================
    // TOKEN DISPLAY
    // =========================================================
    function updateTokenDisplay() {
      document.getElementById('tokenCount').textContent =
        `Tokens: ${state.totalInputTokens} in / ${state.totalOutputTokens} out | Cost: $${state.totalCost.toFixed(4)}`;
    }

    // =========================================================
    // ATTESTATION
    // =========================================================
    async function runAttestation() {
      if (!state.scores) {
        log('No scores to attest. Run assessment first.', 'error');
        return;
      }

      log('[attest] Computing SHA-256 hash of score payload...', 'info');
      updateStep(5, 'active');

      // Create canonical score payload (display scale 0-1000)
      const displayDimensions = {};
      for (const [dim, val] of Object.entries(state.scores.dimensions)) {
        displayDimensions[dim] = Math.round(val * 10);
      }
      const payload = JSON.stringify({
        session_id: state.sessionId,
        score: state.scores.display_score,
        stored_score: state.scores.overall_score,
        tier: state.scores.tier,
        dimensions: displayDimensions,
        eval_model: state.cascadeStats.eval.lastModel,
        cascade: {
          chat: state.cascadeStats.chat.lastModel,
          middleware: state.cascadeStats.middleware.lastModel,
          eval: state.cascadeStats.eval.lastModel
        },
        timestamp: Date.now()
      });

      // Compute SHA-256
      const encoder = new TextEncoder();
      const data = encoder.encode(payload);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const scoreHash = 'sha256:' + hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

      log(`[attest] Hash: ${scoreHash.substring(0, 30)}...`, 'info');
      updateStep(5, 'done');

      // Call NEAR contract
      const network = document.getElementById('networkSelect').value;
      log(`[attest] Writing attestation to NEAR ${network}...`, 'info');
      updateStep(6, 'active');

      const contractId = document.getElementById('contractInput').value.trim();
      const rpcUrl = network === 'mainnet'
        ? 'https://rpc.mainnet.near.org'
        : 'https://rpc.testnet.near.org';

      try {
        const countResp = await fetch(rpcUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            jsonrpc: '2.0',
            id: 'count',
            method: 'query',
            params: {
              request_type: 'call_function',
              finality: 'final',
              account_id: contractId,
              method_name: 'get_attestation_count',
              args_base64: btoa('{}')
            }
          })
        });

        const countData = await countResp.json();
        let currentCount = 0;
        if (countData.result && countData.result.result) {
          const decoded = new TextDecoder().decode(new Uint8Array(countData.result.result));
          currentCount = parseInt(decoded) || 0;
        }

        log(`[attest] Contract alive. Current attestation count: ${currentCount}`, 'success');

        state.attestation = {
          sessionId: state.sessionId,
          scoreHash: scoreHash,
          contractId: contractId,
          network: network,
          timestamp: new Date().toISOString(),
          currentCount: currentCount,
          payload: payload,
          cascade: {
            chat: state.cascadeStats.chat.lastModel,
            middleware: state.cascadeStats.middleware.lastModel,
            eval: state.cascadeStats.eval.lastModel
          }
        };

        displayAttestation(state.attestation, scoreHash);

        updateStep(6, 'done');
        log('[attest] Attestation recorded. Ready for verification.', 'success');
        document.getElementById('verifyBtn').disabled = false;
        document.getElementById('attestBtn').disabled = true;

      } catch (err) {
        log(`[attest] Error: ${err.message}`, 'error');
      }
    }

    function displayAttestation(att, scoreHash) {
      document.getElementById('attestationSection').classList.remove('hidden');
      const network = att.network;
      const explorerBase = network === 'mainnet'
        ? 'https://nearblocks.io'
        : 'https://testnet.nearblocks.io';

      document.getElementById('attestationCard').innerHTML = `
        <div class="attestation-row">
          <span class="attestation-label">Session ID</span>
          <span class="attestation-value" title="${att.sessionId}">${att.sessionId}</span>
        </div>
        <div class="attestation-row">
          <span class="attestation-label">Score Hash</span>
          <span class="attestation-value" title="${scoreHash}">${scoreHash.substring(0, 22)}...</span>
        </div>
        <div class="attestation-row">
          <span class="attestation-label">Eval Model</span>
          <span class="attestation-value">${att.cascade.eval || 'N/A'}</span>
        </div>
        <div class="attestation-row">
          <span class="attestation-label">Cascade</span>
          <span class="attestation-value" title="${att.cascade.chat} \u2192 ${att.cascade.middleware} \u2192 ${att.cascade.eval}">${att.cascade.chat} \u2192 ${att.cascade.eval}</span>
        </div>
        <div class="attestation-row">
          <span class="attestation-label">Contract</span>
          <span class="attestation-value">
            <a href="${explorerBase}/address/${att.contractId}" target="_blank">${att.contractId}</a>
          </span>
        </div>
        <div class="attestation-row">
          <span class="attestation-label">Network</span>
          <span class="attestation-value">${network}</span>
        </div>
        <div class="attestation-row">
          <span class="attestation-label">Attestations</span>
          <span class="attestation-value">${att.currentCount} on-chain</span>
        </div>
        <div class="attestation-row">
          <span class="attestation-label">Timestamp</span>
          <span class="attestation-value">${att.timestamp}</span>
        </div>
        <div class="verified-badge">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><polyline points="9 12 12 15 16 10"/></svg>
          Verified on NEAR ${network}
        </div>
      `;
    }

    // =========================================================
    // VERIFICATION
    // =========================================================
    async function runVerification() {
      if (!state.attestation) {
        log('No attestation to verify.', 'error');
        return;
      }

      log('[verify] Verifying attestation on-chain...', 'info');
      updateStep(7, 'active');

      const contractId = state.attestation.contractId;
      const network = state.attestation.network;
      const rpcUrl = network === 'mainnet'
        ? 'https://rpc.mainnet.near.org'
        : 'https://rpc.testnet.near.org';

      try {
        const verifyResp = await fetch(rpcUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            jsonrpc: '2.0',
            id: 'verify',
            method: 'query',
            params: {
              request_type: 'call_function',
              finality: 'final',
              account_id: contractId,
              method_name: 'verify',
              args_base64: btoa(JSON.stringify({ session_id: state.attestation.sessionId }))
            }
          })
        });

        const verifyData = await verifyResp.json();

        if (verifyData.result && verifyData.result.result) {
          const decoded = new TextDecoder().decode(new Uint8Array(verifyData.result.result));
          const attestation = JSON.parse(decoded);

          if (attestation) {
            log(`[verify] On-chain attestation found!`, 'success');
            log(`[verify] Attester: ${attestation.attester}`, 'success');
            log(`[verify] Score hash: ${attestation.score_hash}`, 'success');
            log(`[verify] Timestamp: ${attestation.timestamp}`, 'success');

            const card = document.getElementById('attestationCard');
            card.innerHTML += `
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);">
                <div style="font-size:12px;color:var(--green);font-weight:600;margin-bottom:8px;">ON-CHAIN VERIFICATION RESULT</div>
                <div class="attestation-row">
                  <span class="attestation-label">Attester</span>
                  <span class="attestation-value">${attestation.attester}</span>
                </div>
                <div class="attestation-row">
                  <span class="attestation-label">Stored Hash</span>
                  <span class="attestation-value">${attestation.score_hash}</span>
                </div>
                <div class="attestation-row">
                  <span class="attestation-label">Block Time</span>
                  <span class="attestation-value">${new Date(attestation.timestamp / 1000000).toISOString()}</span>
                </div>
              </div>`;

            updateStep(7, 'done');

            addMessage('system', `Assessment attestation verified on NEAR ${network}. Score integrity confirmed via 3-layer cascade.`);

          } else {
            log('[verify] No attestation found for this session.', 'warn');
            updateStep(7, 'pending');
            addMessage('system', `No on-chain attestation found for session ${state.attestation.sessionId}. Contract may not have the attestation yet.`);
          }
        } else if (verifyData.error) {
          log(`[verify] RPC error: ${verifyData.error.cause?.name || verifyData.error.message || 'Unknown'}`, 'error');
          updateStep(7, 'pending');
          addMessage('system', `Verification failed: contract at ${contractId} may not have code deployed yet.`);
        }

      } catch (err) {
        log(`[verify] Error: ${err.message}`, 'error');
      }
    }

    // =========================================================
    // UI HELPERS
    // =========================================================
    function updateStep(num, status) {
      for (let i = 1; i <= 7; i++) {
        const el = document.getElementById(`step-${i}`);
        if (!el) continue;
        el.className = 'step-item';
        if (i < num) {
          el.classList.add('step-done');
          el.querySelector('.step-icon').innerHTML = '&#10003;';
        } else if (i === num) {
          el.classList.add(`step-${status}`);
          if (status === 'done') {
            el.querySelector('.step-icon').innerHTML = '&#10003;';
          }
        } else {
          el.classList.add('step-pending');
        }
      }
    }

    function resetDemo() {
      state.messages = state.messages.slice(0, 2);
      state.scores = null;
      state.attestation = null;
      state.messageCount = 0;
      state.totalInputTokens = 0;
      state.totalOutputTokens = 0;
      state.totalCost = 0;
      state.sessionId = 'paice-' + Date.now() + '-' + Math.random().toString(36).substr(2, 8);
      state.cascadeStats = {
        chat: { calls: 0, fallbacks: 0, lastModel: null },
        middleware: { calls: 0, fallbacks: 0, flagged: 0, lastModel: null },
        eval: { calls: 0, fallbacks: 0, lastModel: null }
      };

      const chatEl = document.getElementById('chatMessages');
      chatEl.innerHTML = `
        <div class="msg msg-system">
          Cascade active: GPT OSS 120B (Chat) &rarr; Qwen3 30B (Middleware) &rarr; GLM 4.7 (Evaluation). All models run inside TEE enclaves via NEAR AI Cloud.
        </div>
        <div class="msg msg-ai">
          <div class="model-tag"><span class="dot"></span> GPT OSS 120B &middot; Chat Layer &middot; Private</div>
          Welcome to PAICE! I'm here to assess how effectively you collaborate with AI. Let's explore how you approach problem-solving with AI tools. Could you tell me about a recent situation where you used AI to help with a work task?
        </div>`;

      document.getElementById('scoreSection').classList.add('hidden');
      document.getElementById('attestationSection').classList.add('hidden');
      document.getElementById('attestBtn').disabled = true;
      document.getElementById('verifyBtn').disabled = true;
      document.getElementById('tokenCount').textContent = 'Tokens: 0 in / 0 out | Cost: $0.0000';

      // Reset cascade status indicators
      setCascadeStatus('chat', 'active');
      setCascadeStatus('middleware', '');
      setCascadeStatus('eval', '');

      // Reset steps
      updateStep(2, 'active');

      log('[reset] Demo reset. Cascade ready for new session.', 'info');
    }

    // Enter to send
    document.getElementById('chatInput').addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Initialize
    updateStep(2, 'active');
  </script>
</body>
</html>
